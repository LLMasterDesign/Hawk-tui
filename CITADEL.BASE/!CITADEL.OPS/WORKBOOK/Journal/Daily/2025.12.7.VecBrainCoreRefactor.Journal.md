///▙▖▙▖▞▞▙▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂
▛//▞▞ ⟦⎊⟧ :: ⧗-25.121 // JOURNAL :: vec-brain-core Architecture Refactor ▞▞

▛▞ vec-brain-core Architecture Refactor ::

[Description]
Refactor 3OX brain architecture to use shared core library (`vec-brain-core`) with `brains.rs` as thin wrapper. Core lives in vault (master), `brains.rs` stays as required face but links to core library. Goal: one core brain, `brains.rs` compiles to `_runtime/3ox/rc/brains.exe` as before.

**Problem Statement:**
- Current brains.rs is monolithic with all logic embedded
- Need to avoid compiling dozens of heavy binaries
- Want protected core that can't be accidentally modified
- Need efficient agent creation without full recompilation
- Current structure mixes core logic with agent-specific code

**Solution Approach:**
Minimal refactor to library crate architecture:
- `vec-brain-core` as shared library crate (master in vault)
- `brains.rs` stays as required face, becomes thin wrapper linking to core
- `brains.rs` compiles to `_runtime/3ox/rc/brains.exe` (existing pattern maintained)
- Static linking (Option A) - core compiled into binary as .rlib
- Runtime location: `_runtime/3ox/rc/` (workspace-level, allows future 3OX components)

**Architecture Decisions:**
- **Crate name:** `vec-brain-core` (Rust)
- **Concept name:** `vec.brain.core` (mental model)
- **vec3:** Geometry binder module, not crate name
- **File names:** Use dots (e.g., `face.map.toml`, `manifest.vec3.toml`)
- **Vault (master):** `7HE.VAULT/3OX.Ai/vec-brain-core/` - source code with `src/` directory
- **Base (instance):** `CITADEL.BASE/!WORKDESK/AGENTS/{agent}/.3ox/` - `brains.rs` stays here
- **Runtime:** `_runtime/3ox/rc/` - compiled `brains.exe` (workspace-level, allows future 3OX components)
- **Protection:** Core versioned in vault, `brains.rs` can mutate
- **6 Required Faces:** Must stay (brains.rs, run.rb, tools.yml, routes.json, limits.toml, 3ox.log)

**Implementation Progress:**

**1. Create 3OX.Ai in Vault**
- [ ] Create `7HE.VAULT/3OX.Ai/` directory
- [ ] Move `vec3.core/` → `7HE.VAULT/3OX.Ai/vec-brain-core/`
- [ ] Keep existing files (face.map.toml, manifest.vec3.toml, sparkfile.md, agent.id, build.sh)

**2. Refactor to Library Crate**
- [ ] Convert `Cargo.toml` from binary to library crate
- [ ] Create `src/` directory (only core needs this)
- [ ] Convert `vec3.lib.rs` → `src/vec3.rs` (implement bind_cube)
- [ ] Create `src/lib.rs` with core logic from `brains.rs` (cube loading, logging, session, tool execution)
- [ ] Expose public API (init_brain, etc.) for `brains.rs` to call

**3. Update brains.rs to Link to Core**
- [ ] Update `brains.rs` to depend on `vec-brain-core` library
- [ ] Refactor `brains.rs` to call core library functions instead of containing all logic
- [ ] Keep `main()` in `brains.rs` (required face)
- [ ] Ensure `brains.rs` still compiles to `_runtime/3ox/rc/brains.exe` (existing pattern)

**4. Build and Deploy**
- [ ] Build `brains.rs`: `cargo build --release`
- [ ] Verify output: `_runtime/3ox/rc/brains.exe` (workspace-level runtime)
- [ ] Verify static linking (core compiled into binary)

**5. Update Paths and References**
- [ ] Update `brains.rs` to reference `vec-brain-core` from vault
- [ ] Update build scripts if needed
- [ ] Update documentation

**Key Files Created/Modified:**

**Vault (Master):**
- `7HE.VAULT/3OX.Ai/vec-brain-core/Cargo.toml` - Convert to library
- `7HE.VAULT/3OX.Ai/vec-brain-core/src/lib.rs` - Core logic (from brains.rs)
- `7HE.VAULT/3OX.Ai/vec-brain-core/src/vec3.rs` - Geometry engine (from vec3.lib.rs)

**Base (Instance):**
- `CITADEL.BASE/!WORKDESK/AGENTS/{agent}/.3ox/brains.rs` - Thin wrapper linking to core (modified)
- `CITADEL.BASE/!WORKDESK/AGENTS/{agent}/.3ox/Cargo.toml` - Add dependency on vec-brain-core (if needed)

**Runtime:**
- `_runtime/3ox/rc/brains.exe` - Compiled binary (workspace-level runtime folder)

**Existing Files to Keep (All 6 Required Faces):**
- `brains.rs` - Required face (modified to link to core)
- `run.rb` - Required face
- `tools.yml` - Required face
- `routes.json` - Required face
- `limits.toml` - Required face
- `3ox.log` - Required face
- `face.map.toml` - Cube face declarations
- `manifest.vec3.toml` - Vec3 binding contract
- `sparkfile.md` - Core prompt
- `agent.id` - Agent identity
- `build.sh` - Build script

**Notes During Implementation:**
- File names use dots (e.g., `face.map.toml`), only Rust crate names use dashes
- Only `vec-brain-core/` needs `src/` directory (library crate structure)
- `brains.rs` stays in `.3ox/` as required face, compiles to `_runtime/3ox/rc/brains.exe` as before
- Minimal refactor: extract core logic to library, `brains.rs` becomes thin wrapper
- Option A (static linking) preferred - simpler, type-safe, no ABI concerns
- Core protection: version control + read-only deployment in vault
- `_runtime/3ox/rc/` allows future 3OX components to be compiled in same namespace

**Issues Encountered:**
[Add issues here]

**Next Steps:**
- Move vec-brain-core to vault
- Refactor to library crate structure (src/lib.rs, src/vec3.rs)
- Update brains.rs to link to core

:: ∎ //▚▚▂▂▂▂▂▂▂▂▂▂▂▂
